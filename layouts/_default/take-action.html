{{ define "main" }}
<div class="page-header" data-theme="dark">
  <div class="container">
    <h1>{{ .Title }}</h1>
    {{ with .Params.subtitle }}<p class="lead">{{ . }}</p>{{ end }}
  </div>
</div>

<div class="page-content" data-theme="light">
  <div class="container">
    <div class="ta-wizard">

      <!-- Card 1: Location + Name -->
      <div class="ta-card" id="ta-card-1">
        <div class="glass-card" style="padding: var(--space-lg);">
          <div class="ta-card-header">
            <span class="ta-card-badge">1</span>
            <h3>Where do you live?</h3>
          </div>
          <p style="color: var(--text-subtle); margin-bottom: var(--space-md);">We'll find the right officials who influence street lighting decisions in your area.</p>

          <div class="form-group">
            <label for="ta-location">City, state, or ZIP code</label>
            <input type="text" id="ta-location" placeholder="e.g. Austin, TX or 78701" maxlength="200" autocomplete="address-level2">
          </div>

          <div class="form-group" style="margin-bottom: 0;">
            <label for="ta-name">Your name <span style="font-weight: 400; color: var(--text-subtle);">(optional &mdash; makes the letter more personal)</span></label>
            <input type="text" id="ta-name" placeholder="e.g. Jane Smith" maxlength="100" autocomplete="name">
          </div>
        </div>
      </div>

      <!-- Card 2: Priorities -->
      <div class="ta-card ta-card-locked" id="ta-card-2">
        <div class="glass-card" style="padding: var(--space-lg);">
          <div class="ta-card-header">
            <span class="ta-card-badge">2</span>
            <h3>What matters most to you?</h3>
          </div>
          <p style="color: var(--text-subtle); margin-bottom: var(--space-md);">Select the issues you care about. We'll tailor your letter around these priorities.</p>

          <div class="ta-priorities-grid">
            <label class="ta-priority-card">
              <input type="checkbox" value="Crime & Safety">
              <span class="ta-priority-icon">&#x1F6E1;</span>
              <span class="ta-priority-label">Crime &amp; Safety</span>
            </label>
            <label class="ta-priority-card">
              <input type="checkbox" value="Transportation Safety">
              <span class="ta-priority-icon">&#x1F6A7;</span>
              <span class="ta-priority-label">Transportation Safety</span>
            </label>
            <label class="ta-priority-card">
              <input type="checkbox" value="Children's Safety">
              <span class="ta-priority-icon">&#x1F6B8;</span>
              <span class="ta-priority-label">Children's Safety</span>
            </label>
            <label class="ta-priority-card">
              <input type="checkbox" value="Migratory Birds">
              <span class="ta-priority-icon">&#x1F426;</span>
              <span class="ta-priority-label">Migratory Birds</span>
            </label>
            <label class="ta-priority-card">
              <input type="checkbox" value="Light Pollution">
              <span class="ta-priority-icon">&#x1F30C;</span>
              <span class="ta-priority-label">Light Pollution</span>
            </label>
            <label class="ta-priority-card">
              <input type="checkbox" value="Energy Waste">
              <span class="ta-priority-icon">&#x26A1;</span>
              <span class="ta-priority-label">Energy Waste</span>
            </label>
            <label class="ta-priority-card">
              <input type="checkbox" value="Environmental Impact">
              <span class="ta-priority-icon">&#x1F33F;</span>
              <span class="ta-priority-label">Environmental Impact</span>
            </label>
          </div>

          <div class="form-group" style="margin-top: var(--space-md);">
            <label for="ta-custom-priority">Something else?</label>
            <input type="text" id="ta-custom-priority" placeholder="e.g. Nighttime cycling safety" maxlength="100">
          </div>

          <div style="margin-top: var(--space-md); text-align: center;">
            <button class="btn btn-primary btn-lg" id="ta-generate" style="width: 100%;" disabled>Generate My Letter</button>
          </div>
        </div>
      </div>

      <!-- Card 3: Results -->
      <div class="ta-card ta-card-locked" id="ta-card-3">
        <div class="glass-card" style="padding: var(--space-lg);">
          <div class="ta-card-header">
            <span class="ta-card-badge">3</span>
            <h3>Your Letter</h3>
          </div>

          <!-- Locked placeholder -->
          <div class="ta-card-placeholder" id="ta-placeholder">
            <p>Fill in your location and priorities above, then click <strong>Generate</strong>.</p>
          </div>

          <!-- Loading state -->
          <div class="ta-loading" id="ta-loading" style="display: none;">
            <div class="ta-loading-spinner"></div>
            <p style="color: var(--text-body); font-size: 1.125rem; margin-top: var(--space-md);">Finding and verifying your representatives, then drafting your letter...</p>
            <p style="color: var(--text-subtle); font-size: 0.875rem;">This usually takes 20-30 seconds as we verify each official is current.</p>
          </div>

          <!-- Error state -->
          <div class="ta-error" id="ta-error" style="display: none;">
            <h4 style="color: var(--text-dark); margin-bottom: var(--space-sm);">Something went wrong</h4>
            <p id="ta-error-message" style="color: var(--text-subtle); margin-bottom: var(--space-md);">We couldn't generate your letter. Please try again.</p>
            <button class="btn btn-primary btn-lg" id="ta-retry">Try Again</button>
          </div>

          <!-- Results state -->
          <div class="ta-results" id="ta-results" style="display: none;">

            <!-- Representatives -->
            <div style="margin-bottom: var(--space-lg);">
              <h4 style="color: var(--text-dark); margin-bottom: var(--space-xs);">Recommended Representatives</h4>
              <p style="color: var(--text-subtle); margin-bottom: var(--space-md);">Based on your location and priorities, we recommend contacting these officials about street lighting improvements.</p>
              <div class="ta-reps-grid" id="ta-reps-grid">
                <!-- Rep cards injected by JS -->
              </div>
            </div>

            <!-- Letter -->
            <div style="margin-bottom: var(--space-lg);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-sm);">
                <h4 style="color: var(--text-dark); margin-bottom: 0;">Your Letter</h4>
                <span style="font-size: 0.8125rem; color: var(--text-subtle);">Edit freely before sending</span>
              </div>
              <textarea class="ta-letter-textarea" id="ta-letter" rows="16"></textarea>
            </div>

            <!-- Action buttons -->
            <div class="ta-actions-bar">
              <button class="ta-send-btn ta-send-mailto" id="ta-send-all-email">Send All via Email</button>
              <button class="ta-send-btn ta-send-gmail" id="ta-send-all-gmail">Open All in Gmail</button>
              <button class="ta-send-btn ta-send-copy" id="ta-copy-letter">Copy Letter</button>
              <button class="ta-send-btn ta-send-copy" id="ta-copy-reps">Copy Representatives</button>
            </div>

            <div style="text-align: center; margin-top: var(--space-xl);">
              <button class="btn btn-secondary btn-lg" id="ta-start-over">Start Over</button>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>

<script>
(function() {
  // === Configuration ===
  var API_BASE = "https://eqo2pst6mlkq3gs4lsu32373vu0tbthi.lambda-url.us-east-2.on.aws";
  var sessionId = generateUUID();

  // === DOM refs ===
  var locationInput = document.getElementById("ta-location");
  var nameInput = document.getElementById("ta-name");
  var generateBtn = document.getElementById("ta-generate");
  var letterTextarea = document.getElementById("ta-letter");
  var repsGrid = document.getElementById("ta-reps-grid");
  var customPriority = document.getElementById("ta-custom-priority");
  var retryBtn = document.getElementById("ta-retry");
  var startOverBtn = document.getElementById("ta-start-over");
  var sendAllEmailBtn = document.getElementById("ta-send-all-email");
  var sendAllGmailBtn = document.getElementById("ta-send-all-gmail");
  var copyLetterBtn = document.getElementById("ta-copy-letter");
  var copyRepsBtn = document.getElementById("ta-copy-reps");
  var priorityCheckboxes = document.querySelectorAll(".ta-priority-card input[type=checkbox]");

  var card1 = document.getElementById("ta-card-1");
  var card2 = document.getElementById("ta-card-2");
  var card3 = document.getElementById("ta-card-3");

  var currentReps = [];

  // === Utility functions ===
  function generateUUID() {
    if (crypto && crypto.randomUUID) return crypto.randomUUID();
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(c) {
      var r = Math.random() * 16 | 0;
      return (c === "x" ? r : (r & 0x3 | 0x8)).toString(16);
    });
  }

  function escapeHtml(str) {
    var div = document.createElement("div");
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
  }

  function updateCardStates() {
    var locationFilled = locationInput.value.trim().length >= 2;

    // Card 2: unlock when location has 2+ chars
    if (locationFilled) {
      card2.classList.remove("ta-card-locked");
    } else {
      card2.classList.add("ta-card-locked");
    }

    // Card 3: stays locked until results are shown (managed by generate flow)
    // But re-lock if location is cleared after generation
  }

  function getSelectedPriorities() {
    var selected = [];
    priorityCheckboxes.forEach(function(cb) {
      if (cb.checked) selected.push(cb.value);
    });
    var custom = customPriority.value.trim();
    if (custom) selected.push(custom);
    return selected;
  }

  function updateCheckboxCardStyles() {
    document.querySelectorAll(".ta-priority-card").forEach(function(card) {
      var cb = card.querySelector("input[type=checkbox]");
      if (cb.checked) {
        card.classList.add("selected");
      } else {
        card.classList.remove("selected");
      }
    });
  }

  function updateGenerateBtn() {
    var hasPriority = getSelectedPriorities().length > 0;
    generateBtn.disabled = !hasPriority;
  }

  function buildGroupSalutation(reps) {
    if (!reps.length) return "";
    var names = reps.map(function(rep) {
      // Extract title prefix and last name, e.g. "Mayor Jane Smith" -> "Mayor Smith"
      var parts = rep.name.trim().split(/\s+/);
      var title = rep.title || "";
      // Use title prefix (first word of title) + last name
      var lastName = parts[parts.length - 1];
      var titlePrefix = title.split(/\s+/)[0] || "";
      return titlePrefix ? titlePrefix + " " + lastName : lastName;
    });
    if (names.length === 1) return names[0];
    if (names.length === 2) return names[0] + " and " + names[1];
    return names.slice(0, -1).join(", ") + ", and " + names[names.length - 1];
  }

  function prepareLetterForEmail() {
    var letter = letterTextarea.value;
    var salutation = buildGroupSalutation(currentReps);
    return letter.replace(/\[Official Name\]/g, salutation);
  }

  function buildMailtoUrl() {
    var emails = currentReps.map(function(rep) { return rep.email; }).join(",");
    var body = prepareLetterForEmail();
    var subject = "Intelligent Street Lighting for " + locationInput.value;
    return "mailto:" + emails +
      "?subject=" + encodeURIComponent(subject) +
      "&body=" + encodeURIComponent(body);
  }

  function buildGmailUrl() {
    var emails = currentReps.map(function(rep) { return rep.email; }).join(",");
    var body = prepareLetterForEmail();
    var subject = "Intelligent Street Lighting for " + locationInput.value;
    return "https://mail.google.com/mail/?view=cm" +
      "&to=" + encodeURIComponent(emails) +
      "&su=" + encodeURIComponent(subject) +
      "&body=" + encodeURIComponent(body);
  }

  function trackEvent(event, repEmail) {
    var data = JSON.stringify({
      session_id: sessionId,
      event: event,
      representative_email: repEmail || ""
    });
    if (navigator.sendBeacon) {
      navigator.sendBeacon(API_BASE + "/track", new Blob([data], { type: "application/json" }));
    }
  }

  function renderRepCards() {
    repsGrid.innerHTML = "";
    currentReps.forEach(function(rep) {
      var card = document.createElement("div");
      card.className = "ta-rep-card glass-card";

      card.innerHTML =
        '<div class="ta-rep-info">' +
          '<h4 class="ta-rep-name">' + escapeHtml(rep.name) + '</h4>' +
          '<p class="ta-rep-title">' + escapeHtml(rep.title) + '</p>' +
          '<p class="ta-rep-org">' + escapeHtml(rep.organization) + '</p>' +
          '<p class="ta-rep-relevance">' + escapeHtml(rep.relevance) + '</p>' +
          '<p class="ta-rep-email">' + escapeHtml(rep.email) + '</p>' +
        '</div>';

      repsGrid.appendChild(card);
    });
  }

  function copiedFeedback(btn) {
    var original = btn.textContent;
    btn.textContent = "Copied!";
    btn.classList.add("ta-copied");
    setTimeout(function() {
      btn.textContent = original;
      btn.classList.remove("ta-copied");
    }, 2000);
  }

  function showCard3State(state) {
    // Hide all states
    document.getElementById("ta-placeholder").style.display = "none";
    document.getElementById("ta-loading").style.display = "none";
    document.getElementById("ta-error").style.display = "none";
    document.getElementById("ta-results").style.display = "none";

    // Show requested state
    if (state === "locked") {
      document.getElementById("ta-placeholder").style.display = "block";
      card3.classList.add("ta-card-locked");
    } else if (state === "loading") {
      card3.classList.remove("ta-card-locked");
      document.getElementById("ta-loading").style.display = "block";
    } else if (state === "error") {
      card3.classList.remove("ta-card-locked");
      document.getElementById("ta-error").style.display = "block";
    } else if (state === "results") {
      card3.classList.remove("ta-card-locked");
      document.getElementById("ta-results").style.display = "block";
    }
  }

  // === Card 1: Location validation ===
  locationInput.addEventListener("input", function() {
    updateCardStates();
  });

  // === Card 2: Priority selection ===
  priorityCheckboxes.forEach(function(cb) {
    cb.addEventListener("change", function() {
      updateCheckboxCardStyles();
      updateGenerateBtn();
    });
  });

  customPriority.addEventListener("input", updateGenerateBtn);

  // === Generate letter ===
  generateBtn.addEventListener("click", function() {
    // Show loading in Card 3, scroll to it
    showCard3State("loading");
    card3.scrollIntoView({ behavior: "smooth", block: "center" });

    var payload = {
      session_id: sessionId,
      location: locationInput.value.trim(),
      name: nameInput.value.trim(),
      priorities: getSelectedPriorities()
    };

    fetch(API_BASE + "/generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
    .then(function(response) {
      if (!response.ok) {
        return response.json().then(function(err) {
          throw new Error(err.error || "Request failed");
        });
      }
      return response.json();
    })
    .then(function(data) {
      sessionId = data.session_id || sessionId;
      currentReps = data.representatives || [];
      letterTextarea.value = data.letter || "";

      showCard3State("results");
      renderRepCards();
    })
    .catch(function(err) {
      console.error("Generate error:", err);
      showCard3State("error");
      document.getElementById("ta-error-message").textContent = err.message || "We couldn't generate your letter. Please try again.";
    });
  });

  // === Retry ===
  retryBtn.addEventListener("click", function() {
    generateBtn.click();
  });

  // === Unified action buttons ===
  sendAllEmailBtn.addEventListener("click", function() {
    if (!currentReps.length) return;
    window.location.href = buildMailtoUrl();
    trackEvent("click_mailto_all", currentReps.map(function(r) { return r.email; }).join(","));
  });

  sendAllGmailBtn.addEventListener("click", function() {
    if (!currentReps.length) return;
    window.open(buildGmailUrl(), "_blank");
    trackEvent("click_gmail_all", currentReps.map(function(r) { return r.email; }).join(","));
  });

  copyLetterBtn.addEventListener("click", function() {
    navigator.clipboard.writeText(letterTextarea.value).then(function() {
      copiedFeedback(copyLetterBtn);
    });
    trackEvent("click_copy", "");
  });

  copyRepsBtn.addEventListener("click", function() {
    var text = currentReps.map(function(rep) {
      return rep.name + ", " + rep.title + ", " + rep.organization + " - " + rep.email;
    }).join("\n");
    navigator.clipboard.writeText(text).then(function() {
      copiedFeedback(copyRepsBtn);
    });
  });

  // === Start Over ===
  startOverBtn.addEventListener("click", function() {
    locationInput.value = "";
    nameInput.value = "";
    customPriority.value = "";
    letterTextarea.value = "";
    repsGrid.innerHTML = "";
    currentReps = [];
    priorityCheckboxes.forEach(function(cb) { cb.checked = false; });
    updateCheckboxCardStyles();
    generateBtn.disabled = true;
    sessionId = generateUUID();
    showCard3State("locked");
    updateCardStates();
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

})();
</script>
{{ end }}
